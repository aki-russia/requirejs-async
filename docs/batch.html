<!DOCTYPE html>

<html>
<head>
  <title>batch.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>batch.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>batch.js v 0.1.0
(c) 2012 Dmitriy Kharchenko
<a href="https://github.com/aki-russia/batchjs">https://github.com/aki-russia/batchjs</a>
Freely distributable under the MIT license.</p>
<p>Easy async working with huge amount of data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>window.batch = <span class="keyword">new</span> <span class="function"><span class="params">()</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h3 id="utitity-helpers">Utitity helpers</h3>
<p>Got from underscore.js (<a href="http://underscorejs.org/">http://underscorejs.org/</a>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">is_function</span> = <span class="params">(func)</span> -&gt;</span>
    <span class="keyword">typeof</span> func <span class="keyword">is</span> <span class="string">'function'</span>

  is_array = Array.isArray <span class="keyword">or</span> <span class="function"><span class="params">(obj)</span> -&gt;</span>
    toString.call(obj) <span class="keyword">is</span> <span class="string">'[object Array]'</span>

  <span class="function"><span class="title">is_object</span> = <span class="params">(obj)</span> -&gt;</span>
    obj <span class="keyword">is</span> Object obj

  get_keys = Object.keys <span class="keyword">or</span> <span class="function"><span class="params">(obj)</span> -&gt;</span>
    <span class="keyword">if</span> <span class="keyword">not</span> is_object obj
      <span class="keyword">throw</span> <span class="keyword">new</span> TypeError <span class="string">'Invalid object'</span>

    keys = []
    <span class="keyword">for</span> key <span class="keyword">in</span> obj 
      <span class="keyword">if</span> obj.hasOwnProperty key
        keys[keys.length] = key

    keys</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Some hardcoded defaults for BatchBalancer.
There should be better way for that :-)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  balancer_defaults =
    <span class="attribute">stack_limit</span>: <span class="number">5000</span>,
    <span class="attribute">block_limit</span>: <span class="number">50</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h3 id="batchbalancer-limit-stack_limit-">BatchBalancer(limit, stack_limit)</h3>
<p>Allows to make huge amout of calls without blocked UI</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">BatchBalancer</span> = <span class="params">(limit, stack_limit)</span> -&gt;</span>
    <span class="property">@stack_depth</span> = <span class="number">0</span>
    <span class="property">@_stack_limit</span> = stack_limit <span class="keyword">or</span> balancer_defaults.stack_limit
    <span class="property">@_start_time</span> = +<span class="keyword">new</span> Date()
    <span class="property">@_limit</span> = limit <span class="keyword">or</span> balancer_defaults.block_limit

  <span class="attribute">BatchBalancer</span>:: =</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4 id="batchbalancer-next-callback-">BatchBalancer::next(callback)</h4>
<p>Takes callback and balancing between sync or async call to callback function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">next</span>: <span class="function"><span class="params">(callback)</span> -&gt;</span>
      call_date = +<span class="keyword">new</span> Date()</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>brakes if time or stack limit exeeded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      is_block_limit_exceed = <span class="property">@_limit</span> &lt; (call_date - <span class="property">@_start_time</span>)
      is_stack_overflow = <span class="property">@_stack_limit</span> &lt;= <span class="property">@stack_depth</span>

      <span class="keyword">if</span> is_block_limit_exceed <span class="keyword">or</span> is_stack_overflow
        <span class="property">@_start_time</span> = call_date
        <span class="property">@stack_depth</span> = <span class="number">0</span>
        setTimeout callback, <span class="number">0</span>
      <span class="keyword">else</span>
        <span class="property">@stack_depth</span>++
        callback()</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3 id="iterationflow-iterator-balancer-">IterationFlow(iterator, balancer)</h3>
<p>Initialize with iterator and balancer, and receives data on start.
Controls start/stop of iterations, also collects data and calls complete callbacks when done</p>
<p>Such way of initalizing is for sake of asyncronus nature, 
when initialising new interation flow, there still might be no data for it.
Data appears after previous flow is done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">IterationFlow</span> = <span class="params">(<span class="property">@iterator</span>, <span class="property">@balancer</span>)</span> -&gt;</span>
    <span class="property">@state</span> = {}
    <span class="property">@_handlers</span> = []

    <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@balancer</span>
      <span class="property">@balancer</span> = <span class="keyword">new</span> BatchBalancer()

    @

  <span class="attribute">IterationFlow</span>:: =</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h4 id="iterationflow-_call_complete_handlers-">IterationFlow::_call_complete_handlers()</h4>
<p>Calls complete callbacks with BatchBalancer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">_call_complete_handlers</span>: <span class="function"><span class="params">()</span> -&gt;</span>
      <span class="keyword">if</span> <span class="number">0</span> &lt; <span class="property">@_handlers</span>.length
        handler = <span class="property">@_handlers</span>.shift()
        handler_result = handler <span class="property">@result</span>, <span class="property">@state</span>

        <span class="keyword">if</span> handler_result <span class="keyword">isnt</span> <span class="literal">undefined</span>
          <span class="property">@result</span> = handler_result

        <span class="property">@balancer</span>.next<span class="function"> =&gt;</span>
          <span class="property">@_call_complete_handlers</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h4 id="iterationflow-start-data-">IterationFlow::start(data)</h4>
<p>Initializes iteration function for data.
If iteration flow didn&#39;t received iterator, then makes empty one, which  only completes flow and calls complete handlers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">start</span>: <span class="function"><span class="params">(data)</span> -&gt;</span>
      <span class="keyword">if</span> <span class="property">@_iteration</span>
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@state</span>.is_complete
          <span class="property">@balancer</span>.next <span class="property">@_iteration</span>
        <span class="keyword">else</span>
          <span class="property">@_call_complete_handlers</span>()
      <span class="keyword">else</span> 
        <span class="property">@data</span> = data
        <span class="property">@is_array_data</span> = is_array(<span class="property">@data</span>)
        keys = (<span class="keyword">if</span> <span class="property">@is_data_array</span> <span class="keyword">or</span> is_object(<span class="property">@data</span>) <span class="keyword">then</span> get_keys(<span class="property">@data</span>) <span class="keyword">else</span> [])</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>empty iterator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> <span class="keyword">not</span> is_function <span class="property">@iterator</span>

          <span class="property">@_iteration</span> = <span class="function"><span class="params">()</span> =&gt;</span>

            <span class="property">@state</span>.is_complete = <span class="literal">true</span>
            <span class="property">@result</span> = <span class="property">@data</span>
            <span class="property">@_call_complete_handlers</span>()

        <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>iteration function, gets next key (or index), takes data for this key and calls iterator callback.
When comes to the end, calls complete handlers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="property">@_iteration</span> = <span class="function"><span class="params">()</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>stops if flow is paused</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> <span class="property">@state</span>.is_wait

            <span class="keyword">if</span> keys.length <span class="keyword">isnt</span> <span class="number">0</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="property">@state</span>.is_complete
              next_index = keys.shift()

              <span class="keyword">if</span> <span class="property">@is_array_data</span>
                next_index = +next_index

              result = <span class="property">@iterator</span> <span class="property">@data</span>[next_index], next_index, @</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>collecting data from iterator callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="keyword">if</span> result <span class="keyword">isnt</span> <span class="literal">undefined</span>
                <span class="property">@result</span> = (<span class="keyword">if</span> <span class="property">@is_array_data</span> <span class="keyword">then</span> [] <span class="keyword">else</span> {}) <span class="keyword">unless</span> <span class="property">@result</span>
                <span class="property">@result</span>[next_index] = result

              <span class="property">@balancer</span>.next <span class="property">@_iteration</span>
            <span class="keyword">else</span>
              <span class="property">@state</span>.is_complete = <span class="literal">true</span>
              <span class="property">@_call_complete_handlers</span>()

        <span class="property">@balancer</span>.next <span class="property">@_iteration</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h4 id="iterationflow-stop-">IterationFlow::stop()</h4>
<p>Stops iterations and cause calling complete handlers,
since that there is no way to resume iterations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">stop</span>: <span class="function"><span class="params">()</span> -&gt;</span>
      <span class="property">@state</span>.is_complete = <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h4 id="iterationflow-pause-">IterationFlow::pause()</h4>
<p>Pauses iterations without calling complete handlers,
it can be resumed later with IterationFlow::resume() method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">pause</span>: <span class="function"><span class="params">()</span> -&gt;</span>
      <span class="property">@state</span>.is_wait = <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h4 id="iterationflow-resume-">IterationFlow::resume()</h4>
<p>Resumes iterations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">resume</span>: <span class="function"><span class="params">()</span> -&gt;</span>
      <span class="property">@state</span>.is_wait = <span class="literal">false</span>
      <span class="property">@start</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h4 id="iterationflow-on_complete-">IterationFlow::on_complete()</h4>
<p>Binds handler to complete of this flow</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">on_complete</span>: <span class="function"><span class="params">(handler)</span> -&gt;</span>
      <span class="keyword">if</span> is_function handler
        <span class="property">@_handlers</span>.push handler

        <span class="keyword">if</span> <span class="property">@state</span>.is_complete
          <span class="property">@_call_complete_handlers</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3 id="stream">Stream</h3>
<p>Consumes data and iterator for it, chain it with previous iteration flow, or just start new flow, and return result to complete callbacks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">Stream</span> = <span class="params">(data)</span> -&gt;</span>
    <span class="property">@current_flow</span> = <span class="keyword">new</span> IterationFlow()
    <span class="property">@current_flow</span>.start data <span class="keyword">or</span> []

    <span class="property">@_balancer</span> = <span class="keyword">new</span> BatchBalancer
    @

  <span class="attribute">Stream</span>:: =</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h4 id="stream-_push-data-">Stream::_push(data)</h4>
<p>creates new iterations flow and chains it to previous one
&#39;data&#39; should contain iterator function or/and complete handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">_push</span>: <span class="function"><span class="params">(data)</span> -&gt;</span>
      new_flow = <span class="keyword">new</span> IterationFlow(data.iterator, <span class="property">@_balancer</span>)
      new_flow.on_complete data.complete

      <span class="property">@current_flow</span>.on_complete <span class="function"><span class="params">(data, state)</span> -&gt;</span>
        new_flow.start data

      <span class="property">@current_flow</span> = new_flow
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h4 id="stream-stop-">Stream::stop()</h4>
<p>Stops current flow. It is mean that current flow will call all complete handlers 
and next flow (if exist) also will start.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">stop</span>:<span class="function"> -&gt;</span>
      <span class="property">@current_flow</span>.stop()
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h4 id="stream-use-data-">Stream::use(data)</h4>
<p>Set data for any next iterations, any previous data will be thrown away.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">use</span>: <span class="function"><span class="params">(data)</span> -&gt;</span>
      <span class="property">@_push</span> <span class="attribute">complete</span>: <span class="function"><span class="params">()</span> -&gt;</span>
        data
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h4 id="stream-each-iterator-">Stream::each(iterator)</h4>
<p>Calls iterator for each element in data,
stops if iterator return false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">each</span>: <span class="function"><span class="params">(iterator)</span> -&gt;</span>
      <span class="property">@_push</span> <span class="attribute">iterator</span>: <span class="function"><span class="params">(value, index, flow)</span> =&gt;</span>
        result = iterator(value, index, flow)
        flow.stop() <span class="keyword">if</span> result <span class="keyword">is</span> <span class="literal">false</span>
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h4 id="stream-map-transformator-">Stream::map(transformator)</h4>
<p>Produces new hash or array (depends of source data) 
by mapping elements from source through a &#39;transformator&#39; function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">map</span>: <span class="function"><span class="params">(transformator)</span> -&gt;</span>
      <span class="property">@_push</span>
        <span class="attribute">iterator</span>: transformator</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h4 id="stream-reduce-iterator-summary_initial-">Stream::reduce(iterator, summary_initial)</h4>
<p>Converts data into a single value.
Initial state of reduce value can be set in second argument.
Iterator for &#39;reduce()&#39; method accepts additional 3rd argument &#39;summary&#39;,
(&#39;flow&#39; is 4th in this case)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">reduce</span>: <span class="function"><span class="params">(iterator, summary_initial)</span> -&gt;</span>
      summary = summary_initial
      <span class="property">@_push</span>
        <span class="attribute">iterator</span>: <span class="function"><span class="params">(value, index, flow)</span> -&gt;</span>
          result = iterator(value, index, summary, flow)
          <span class="keyword">if</span> result <span class="keyword">isnt</span> <span class="literal">undefined</span>
            summary = result

        <span class="attribute">complete</span>: <span class="function"><span class="params">(data, state)</span> -&gt;</span>
          summary
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h4 id="stream-find-iterator-">Stream::find(iterator)</h4>
<p>Finds first element in collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">find</span>: <span class="function"><span class="params">(iterator)</span> -&gt;</span>
      found = <span class="literal">undefined</span>
      <span class="property">@_push</span>
        <span class="attribute">iterator</span>: <span class="function"><span class="params">(value, index, flow)</span> -&gt;</span>
          <span class="keyword">if</span> iterator(value, index, flow)
            found = value
            flow.stop()

        <span class="attribute">complete</span>: <span class="function"><span class="params">(state)</span> -&gt;</span>
          found
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h4 id="stream-next-handler-">Stream::next(handler)</h4>
<p>Binds handler to complete of current flow</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="attribute">next</span>: <span class="function"><span class="params">(handler)</span> -&gt;</span>
      <span class="property">@current_flow</span>.on_complete <span class="function"><span class="params">(result, state)</span> -&gt;</span>
        handler(result)
        <span class="keyword">return</span> <span class="literal">undefined</span>
      @


  <span class="function"><span class="params">(data)</span> -&gt;</span>
    <span class="keyword">new</span> Stream(data)</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
